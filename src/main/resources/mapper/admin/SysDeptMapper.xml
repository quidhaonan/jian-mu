<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lmyxlf.jian_mu.admin.dao.SysDeptDao">

    <select id="selectDeptList" resultType="com.lmyxlf.jian_mu.admin.model.resp.RespSysDept">
        select dept.id,dept.parent_id,dept.ancestors,dept.dept_name,dept.order_num,dept.leader,
               dept.phone,dept.email,dept.status,dept.create_user,dept.create_time,dept.update_user,
               dept.update_time,dept.delete_time
        from sys_dept dept
        where dept.delete_time = '1970-01-01 00:00:00'

        <if test="id != null and id != 0">
            AND id = #{id}
        </if>
        <if test="parentId != null and parentId != 0">
            AND parent_id = #{parentId}
        </if>
        <if test="deptName != null and deptName != ''">
            AND dept_name like concat('%', #{deptName}, '%')
        </if>
        <if test="status != null">
            AND status = #{status}
        </if>
        <!-- 数据范围过滤 -->
        ${dataScopeSql}
        order by dept.parent_id, dept.order_num
    </select>

    <select id="selectDeptById" resultType="com.lmyxlf.jian_mu.admin.model.entity.SysDept">
        select dept.id,dept.parent_id,dept.ancestors,dept.dept_name,dept.order_num,dept.leader,
               dept.phone,dept.email,dept.status,dept.create_user,dept.create_time,dept.update_user,
               dept.update_time,dept.delete_time,
               (select dept_name from sys_dept where id = d.parent_id) parent_name
        from sys_dept dept
        where dept.id = #{id}
    </select>

    <select id="selectNormalChildrenDeptById" resultType="java.lang.Integer">
        select count(*)
        from sys_dept
        where status = 0
        and find_in_set(#{id}, ancestors)
        and delete_time = '1970-01-01 00:00:00'
    </select>

    <select id="selectChildrenDeptById" resultType="com.lmyxlf.jian_mu.admin.model.entity.SysDept">
        select *
        from sys_dept
        where find_in_set(#{id}, ancestors)
        and delete_time = '1970-01-01 00:00:00'
    </select>

    <select id="selectDeptListByRoleId" resultType="java.lang.Integer">
        select sys_dept.id
        from sys_dept
        left join sys_role_dept on sys_dept.id = sys_role_dept.dept_id
        where sys_role_dept.role_id = #{roleId}
        <if test="deptCheckStrictly = 1">
            and sys_dept.id not in
                (select sys_dept.parent_id
                 from sys_dept
                 inner join sys_role_dept on dsys_dept.id = sys_role_dept.dept_id
                 and sys_role_dept.role_id = #{roleId})
        </if>
        order by sys_dept.parent_id, sys_dept.order_num
    </select>
</mapper>